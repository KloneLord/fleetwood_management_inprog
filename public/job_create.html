<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link href="styles.css" rel="stylesheet">
    <style>
        body {
            background-color: #f4f6f9;
        }

        .form-section {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: #fff;
        }

        .form-section h3 {
            color: #20c997;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
<!-- Top Navigation -->
<div class="topnav" id="topnav">
    <div class="container-fluid">
        <!-- User Info -->
        <div id="user-info">
            Welcome <span id="username">User</span>, logged in for
            <span id="session-duration">00:00:00</span>
        </div>

        <!-- Live Clock + Icons -->
        <div class="icon-section">
            <div>
                Current Time: <span id="live-clock">Loading...</span>
            </div>
            <!-- Notifications Icon -->
            <div class="icon-wrapper">
                <i class="fas fa-bell"></i>
                <span class="badge bg-danger">3</span>
            </div>
            <!-- Messages Icon -->
            <div class="icon-wrapper">
                <i class="fas fa-envelope"></i>
                <span class="badge bg-primary">5</span>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar"></div>

<!-- Main Content -->
<div class="content-wrapper">
    <main class="container">
        <form id="createJobForm">
            <!-- Job Information -->
            <div class="form-section">
                <h3>Create a Job</h3>


                <div class="row align-items-center">
                    <div class="col-md-4 mb-3">
                        <label for="customer" class="form-label">Select Customer</label>
                        <select class="form-control" id="customer" name="customer" required>
                            <option value="">Select a customer</option>
                        </select>
                    </div>

                </div>
                <div class="row align-items-center">

                    <div class="col-md-4 mb-3">
                        <label for="jobSite" class="form-label">Select Job Site</label>
                        <select class="form-control" id="jobSite" name="jobSite" required>
                            <option value="">Select a job site</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jobSiteAddy" id="jobSiteAddyLabel" class="form-label">Job site address</label>
                        <input type="text" class="form-control" id="jobSiteAddy" name="jobSiteAddy">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="customerIDLabel" id="customerIDLabel" class="form-label">Customer ID</label>
                        <input type="text" class="form-control" id="customerID" name="customerID">
                    </div>
                </div>

                <div class="mb-3">
                    <label for="jobTitle" class="form-label">Job Title</label>
                    <input type="text" class="form-control" id="jobTitle" name="jobTitle" required>
                </div>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="jobType" class="form-label">Job Type</label>
                        <select class="form-control" id="jobType" name="jobType">
                            <option value="">Select a type</option>
                            <option value="Repair">Repair</option>
                            <option value="Maintenance">Maintenance</option>
                            <option value="Project">Project</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jobPriority" class="form-label">Priority</label>
                        <select class="form-control" id="jobPriority" name="jobPriority">
                            <option value="Normal">Medium</option>
                            <option value="High">High</option>
                            <option value="Urgent">Urgent</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="jobStatus" class="form-label">Status</label>
                        <select class="form-control" id="jobStatus" name="jobStatus">
                            <option value="Registered">In the System</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Cancelled">Cancelled</option>
                            <option value="To Invoice">To Invoice</option>
                            <option value="Complete">Complete</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="jobDescription" class="form-label">Job Description</label>
                    <textarea class="form-control" id="jobDescription" name="jobDescription" rows="4"></textarea>
                </div>
            </div>

            <div class="text-start">
                <button type="submit" class="btn btn-primary">Create Job</button>
            </div>
        </form>


    </main>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<!-- Sidebar Script -->
<script src="/utils/sidebar.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const customerDropdown = document.getElementById('customer');
        const jobSiteDropdown = document.getElementById('jobSite');
        const jobSiteAddyInput = document.getElementById('jobSiteAddy');

        let jobSitesCache = []; // Cache for the job sites of the selected customer

        // Fetch customers from the database
        const fetchCustomers = async () => {
            console.log('Fetching customers from the database...');
            try {
                const response = await axios.get('/api/customers');
                console.log('Customer fetch response:', response.data);
                if (response.data && Array.isArray(response.data)) {
                    return response.data;
                } else {
                    console.error('Invalid customer data received.');
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
                alert('Failed to load customers. Please try again.');
                return [];
            }
        };

        // Populate customer dropdown
        const populateCustomerDropdown = (customers) => {
            console.log('Populating customer dropdown with data:', customers);
            customerDropdown.innerHTML = '<option value="">Select a customer</option>';
            customers.forEach((customer) => {
                const option = document.createElement('option');
                option.value = customer._id;
                option.textContent = customer.customerName;
                customerDropdown.appendChild(option);
            });
        };

        // Fetch job sites for the selected customer
        const fetchJobSites = async (customerId) => {
            console.log(`Fetching job sites for customer ID: ${customerId}`);
            try {
                const response = await axios.get(`/api/customers/${customerId}`);
                console.log('Job sites fetch response:', response.data);
                if (response.data && Array.isArray(response.data.jobSites)) {
                    return response.data.jobSites;
                } else {
                    console.error('No job sites found for this customer.');
                }
            } catch (error) {
                console.error('Error fetching job sites:', error);
                alert('Failed to load job sites. Please try again.');
                return [];
            }
        };

        // Populate job site dropdown
        const populateJobSiteDropdown = (jobSites) => {
            console.log('Populating job site dropdown with data:', jobSites);
            jobSiteDropdown.innerHTML = '<option value="">Select a job site</option>';
            jobSites.forEach((site) => {
                const option = document.createElement('option');
                option.value = site._id; // Use job site ID as the value
                option.textContent = site.siteName; // Use site name as the display text
                jobSiteDropdown.appendChild(option);
            });
        };

        // Handle customer selection
        const handleCustomerSelection = async () => {
            const selectedCustomerId = customerDropdown.value;
            console.log(`Customer selected: ${selectedCustomerId}`);

            if (!selectedCustomerId) {
                console.warn('No customer selected.');
                jobSiteDropdown.innerHTML = '<option value="">Select a job site</option>';
                jobSitesCache = []; // Clear job site cache
                return;
            }

            jobSitesCache = await fetchJobSites(selectedCustomerId);
            console.log('Updated jobSitesCache:', jobSitesCache);
            populateJobSiteDropdown(jobSitesCache);
        };

        // Handle job site dropdown click
        const handleJobSiteClick = () => {
            console.log('Job site dropdown clicked.');
            const selectedJobSiteId = jobSiteDropdown.value;
            console.log(`Selected job site ID: ${selectedJobSiteId}`);

            if (!selectedJobSiteId) {
                console.warn('No job site selected.');
                jobSiteAddyInput.value = ''; // Clear the address field if no site is selected
                return;
            }

            const selectedJobSite = jobSitesCache.find((site) => site._id === selectedJobSiteId);
            console.log('Selected job site:', selectedJobSite);

            if (selectedJobSite) {
                jobSiteAddyInput.value = selectedJobSite.siteAddress; // Populate the address field
            } else {
                console.warn('No matching job site found in cache.');
                jobSiteAddyInput.value = ''; // Clear the address field if no match is found
            }
        };

        // Initialize the form
        const initializeForm = async () => {
            console.log('Initializing form...');
            const customers = await fetchCustomers();
            console.log('Customers loaded:', customers);
            populateCustomerDropdown(customers);

            // Add event listener for customer dropdown
            customerDropdown.addEventListener('change', handleCustomerSelection);

            // Add event listener for job site dropdown click
            jobSiteDropdown.addEventListener('click', handleJobSiteClick);
            console.log('Event listeners added for dropdowns.');
        };

        // Start initialization
        console.log('Starting form initialization...');
        await initializeForm();
        console.log('Form initialization complete.');
    });


    document.getElementById('createJobForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const customerDropdown = document.getElementById('customer');
        const jobSiteDropdown = document.getElementById('jobSite');
        const jobSiteAddyInput = document.getElementById('jobSiteAddy');

        // Prepare job data
        const jobData = {
            jobTitle: document.getElementById('jobTitle').value,
            customerId: customerDropdown.value,
            customerName: customerDropdown.options[customerDropdown.selectedIndex]?.text, // Get the text of the selected option
            jobSiteId: jobSiteDropdown.value,
            jobSiteName: jobSiteDropdown.options[jobSiteDropdown.selectedIndex]?.text, // Get the text of the selected job site
            jobSiteAddress: jobSiteAddyInput.value, // Already populated when the dropdown is clicked
            jobType: document.getElementById('jobType').value,
            jobPriority: document.getElementById('jobPriority').value,
            jobStatus: document.getElementById('jobStatus').value,
            jobDescription: document.getElementById('jobDescription').value,
        };

        console.log('Submitting job data:', jobData);

        try {
            const response = await axios.post('/api/jobs', jobData);
            console.log('Job created successfully:', response.data);
            alert('Job created successfully!');
            document.getElementById('createJobForm').reset();
        } catch (error) {
            console.error('Error creating job:', error);
            alert('Failed to create job. Please try again.');
        }
    });


</script>

<script>
    // Fetch session data from the server
    async function fetchSessionData() {
        try {
            const response = await fetch('/api/sessions/info');
            if (!response.ok) throw new Error('Failed to fetch session data');
            const data = await response.json();

            // Log session data
            console.log('Session data received:', data);

            // Update the username
            const usernameElement = document.getElementById('username');
            if (usernameElement) {
                usernameElement.innerText = data.username;
            }

            // Start the session timer
            startSessionTimer(data.loginTime);

            return data;
        } catch (error) {
            console.error('Error fetching session data:', error);
            return null;
        }
    }

    // Start a session duration timer
    function startSessionTimer(loginTime) {
        const loginTimestamp = new Date(loginTime).getTime();

        if (isNaN(loginTimestamp)) {
            console.error('Invalid loginTime:', loginTime);
            return;
        }

        setInterval(() => {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - loginTimestamp) / 1000);
            const hours = String(Math.floor(elapsedSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((elapsedSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(elapsedSeconds % 60).padStart(2, '0');

            const durationElement = document.getElementById('session-duration');
            if (durationElement) {
                durationElement.innerText = `${hours}:${minutes}:${seconds}`;
            } else {
                console.error('session-duration element not found');
            }
        }, 1000);
    }

    // Start a live clock
    function startLiveClock() {
        setInterval(() => {
            const now = new Date();
            const clockElement = document.getElementById('live-clock');
            if (clockElement) {
                clockElement.innerText = now.toLocaleTimeString();
            }
        }, 1000);
    }

    // Initialize all functions on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', async () => {
        await fetchSessionData();
        startLiveClock();
    });
</script>
</body>
</html>
